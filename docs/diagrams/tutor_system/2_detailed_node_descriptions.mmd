flowchart TD
    Start([Start]) --> LC
    
    LC[<b>load_context</b><br/>• Load node data<br/>• Get learning objectives<br/>• Filter by mastery < 0.7<br/>• Get prerequisites<br/>• Initialize session log]
    
    LC --> TI[<b>tutor_intro</b><br/>• Welcome message<br/>• If prerequisites exist:<br/>  Ask quiz or summary?<br/>• Else skip to teaching]
    
    TI -->|Conditional Edge| Prereq{<b>should_do_prerequisites</b>}
    
    Prereq -->|no prerequisites| TL
    Prereq -->|user chose quiz| PQB[<b>prereq_quiz_build</b><br/>• Generate ≤ 4 questions<br/>• From prerequisite objectives]
    Prereq -->|user chose summary| PR[<b>prereq_recap</b><br/>• Summarize prerequisites<br/>• ≤ 200 words<br/>• Connect to current topic]
    Prereq -->|still waiting| TI
    
    PQB --> PQA[<b>prereq_quiz_ask</b><br/>• Ask questions one by one<br/>• Evaluate answers<br/>• Show feedback<br/>• Display summary at end]
    
    PQA --> TL
    PR --> TL
    
    TL[<b>tutor_loop</b><br/>State Machine per Objective:<br/>• probe_ask → probe_respond<br/>• explain_present → explain_respond<br/>• quiz_ask → quiz_evaluate<br/>• Move to next objective]
    
    TL -->|Conditional Edge| Teach{<b>should_continue_teaching</b>}
    
    Teach -->|continue<br/>more objectives| TL
    Teach -->|finish<br/>all done or forced end| FTB
    Teach -->|wait_for_input<br/>need user response| End1([Pause for User Input])
    
    FTB[<b>final_test_build</b><br/>• Generate 6 questions<br/>• 3 MCQ + 2 short + 1 paraphrase<br/>• Cover objectives taught]
    
    FTB --> FTA[<b>final_test_ask</b><br/>• Present all questions<br/>• Collect user answers]
    
    FTA --> GP[<b>grade_prep</b><br/>• Use LLM to parse answers<br/>• Handle varied formats<br/>• Create TestAnswer objects]
    
    GP --> GC[<b>grader_call</b><br/>• Grade with GPT-4o<br/>• Fallback to GPT-4o-mini<br/>• Update mastery scores<br/>• Add transition message]
    
    GC --> TWU[<b>tutor_wrap_up</b><br/>• Calculate final score<br/>• Show performance summary<br/>• Highlight strengths/weaknesses<br/>• Suggest next steps]
    
    TWU --> End2([Session Complete])
    
    style LC fill:#e1bee7,stroke:#4a148c,stroke-width:2px
    style TL fill:#bbdefb,stroke:#0d47a1,stroke-width:4px
    style Prereq fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    style Teach fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    style GC fill:#c8e6c9,stroke:#1b5e20,stroke-width:2px
    style End1 fill:#ffcdd2,stroke:#b71c1c,stroke-width:2px
    style End2 fill:#dcedc8,stroke:#33691e,stroke-width:2px 